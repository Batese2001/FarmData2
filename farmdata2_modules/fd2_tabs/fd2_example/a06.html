<body>
    <h1>Harvest Report</h1>
    <br />
    <p>
        This page is a <i>mockup</i> of a form for generating a harvest report
    </p>
    <br />

    <div id="rptVue" v-cloak>
        <label for="”title”">Title:</label>
        <input type="text" v-model="rptTitle" id="”title”" />

        <br /><br />

        <label for="start">Start:</label>
        <input
            type="date"
            id="start"
            v-model="rptStart"
            min="2014-01-01"
            :max="rptEnd"
        />

        <label for="end">End:</label>
        <input
            type="date"
            id="end"
            v-model="rptEnd"
            :min="rptStart"
            max="2022-01-01"
        />

        <br /><br />

        <label for="”crop”">Crop:</label>
        <select id="crop" v-model="rptCrop">
            <option v-for="crop in crops">{{ crop }}</option>
        </select>

        <label for=”field” >Field:</label>
        <select id="field"v-model="rptField">
            <option v-for="field in fields">{{ field }}</option>
        </select>

        <br /><br />
        <button class="btn btn-primary" @click="genRpt">Generate Report</button>

        <div v-if="visible">
            <hr />

            <h1>{{ rptTitle == '' ? 'My Mock Harvest Report' : rptTitle }}</h1>
            <br />

            <p>Details:</p>
            <br />
            <ul>
                <li><strong>Start:</strong>{{ rptStart }}</li>
                <li><strong>End:</strong> {{ rptEnd }}</li>
                <li><strong>Crop:</strong>{{ rptCrop }}</li>
            </ul>
            <br />
            <p v-if="table.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in headers">{{ header }}</th>
                </tr>
                <tr v-for="(log, index) in table">
                    <td>{{ log.date }}</td>
                    <td>{{ log.field }}</td>
                    <td>{{ log.crop }}</td>
                    <td>{{ log.yield }}</td>
                    <td>
                        <button type="button" @click="deleteLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
            <p>{{ 'Total Yield: ' + totalYield}}</p>
        </div>
    </div>

    <script>
        var rptVue = new Vue({
            el: '#rptVue',
            data: {
                rptPath: '',
                rptTitle: '',
                rptStart: '2018-05-01',
                rptEnd: '2018-05-15',
                rptCrop: 'Kale',
                rptField: 'SQ 5',
                crops: [],
                fields: [],
                visible: false,
                headers: ['Date', 'Field', 'Crop', 'Yield', 'Delete'],
                log: [],
                table: [],
            },
            computed: {
                totalYield() {
                    total = 0;
                    for (log in this.table) {
                        yield = parseInt(this.table[log].yield.split(' ')[0]);
                        total += yield;
                    }
                    return total;
                },
            },
            methods: {
                makePath: function (field) {
                    this.rptPath = '/log.json?type=farm_harvest&area=' + field;
                },
                genRpt: function () {
                    this.makePath(this.rptField)
                    axios
                        .get(this.rptPath)
                        .then((response) => {
                            this.log = response.data.list.map((h) => {
                                return {
                                    date: this.timestampToYMD(h.timestamp),
                                    field: h.area[0].name,
                                    crop: h.name.split(" ")[h.name.split(" ").length - 1],
                                    yield: h.quantity[0].value + " " + h.quantity[0].unit.name,
                                };
                            });
                        });
                    if (this.table.length < 3 && this.visible) {
                        this.table.push(this.log[this.table.length]);
                    }
                    this.visible = true;
                },
                deleteLog: function (nameIndex) {
                    this.table.splice(nameIndex, 1);
                },
                
                
                timestampToDate: function (timestamp) {
                    return new Date(timestamp * 1000);
                },
                timestampToYMD: function (timestamp) {
                    let d = this.timestampToDate(timestamp);
                    const month =
                        d.getMonth() < 9
                            ? '0' + (d.getMonth() + 1)
                            : d.getMonth() + 1;
                    const day =
                        d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
                    return d.getFullYear() + '-' + month + '-' + day;
                },
                
            },
            created() {
                axios
                    .get('/taxonomy_term.json?area_type=field')
                    .then((response) => {
                        this.fields = response.data.list.map((f) => f.name);
                    });
                axios.get('/farm_asset.json?type=planting').then((response) => {
                    this.crops = response.data.list.map((f) => f.name);
                });
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
