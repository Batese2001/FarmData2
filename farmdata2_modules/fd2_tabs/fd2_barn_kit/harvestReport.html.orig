<body>
    <h1>Harvest Report</h1>
    <br />
    <p>This page is a form for generating a harvest report</p>
    <br />
    <div id="harvRptVue" v-cloak>
        <label for="rptTitle">Title:</label>
        <input type="text" v-model="harvRptTitle" id="rptTitle" />

        <label for="field">Field: </label>
<<<<<<< HEAD
        <select v-model="harvRptField">
            <option v-for="field in harvFields">{{field}}</option>
=======
        <select v-model="reportField">
            <option v-for="field in fields">{{field}}</option>
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
        </select>

        <div>
            <label for="start">Start:</label>
<<<<<<< HEAD
            <input type="date" id="start" v-model="rptStart" />

            <label for="end">End:</label>
            <input type="date" id="end" v-model="rptEnd" />
        </div>

        <br />
        <br />

=======
            <input type="date" id="start" :max="reportEndDate" v-model="reportStartDate" />

            <label for="end">End:</label>
            <input type="date" id="end" :min="reportStartDate" v-model="reportEndDate" />
        </div>

        <br /><br />
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
        <label for="”crop”">Crop:</label>
        <select id="crop" v-model="harvRptCrop">
            <option v-for="crop in harvCrops">{{ crop }}</option>
        </select>
<<<<<<< HEAD

        <br />
        <br />
=======
        <br /><br />
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5

        <button class="btn btn-primary" @click="genHarvRpt">
            Generate Report
        </button>
<<<<<<< HEAD

        <div v-if="visible">
            <hr />

            <h1>{{ savedTitle == '' ? 'My Harvest Report' : savedTitle }}</h1>

            <br />
            <br />

            <ul>
                <li><strong>Start:</strong>{{' ' + savedStart}}</li>
                <li><strong>End:</strong> {{' ' + savedEnd}}</li>
                <li><strong>Crop:</strong>{{' ' + savedCrop }}</li>
                <li><strong>Field: </strong>{{' ' + savedField}}</li>
            </ul>

            <br />

            <p v-if="harvTable.length == 0">There are no matching records.</p>

            <div v-else>
                <table border="1">
                    <tr>
                        <th v-for="header in harvHeaders">{{ header }}</th>
                    </tr>

                    <tr v-for="(harvLog, index) in harvTable">
                        <td>{{ timestampToYMD(harvLog.date) }}</td>
                        <td>{{ harvLog.field }}</td>
                        <td>{{ harvLog.crop }}</td>
                        <td>{{ harvLog.yield }}</td>
                        <td>{{ harvLog.worker }}</td>
                        <td>
                            <button type="button" @click="deleteHarvLog(index)">
                                Delete
                            </button>
                        </td>
                    </tr>
                </table>

                <br />

                <table border="1">
                    <tr>
                        <th v-for="header in totYieldHeaders">{{ header }}</th>
                    </tr>
                    <tr v-for="cropYield in yieldTable">
                        <td>{{ cropYield[0] }}</td>
                        <td>{{ cropYield[1] }}</td>
                    </tr>
                </table>

                <a id="tableDownload" :download="savedTitle + '.csv'" :href="makeFile()"
                    >Download Tables</a
                >

            </div>
        </div>
    </div>

=======
        <div v-if="visible">
            <hr />
            <h1>
                {{ harvRptTitle == '' ? 'My Harvest Report' : harvRptTitle }}
            </h1>
            <br />
            <br />
            <ul>
                <li><strong>Start:</strong>{{' ' + reportStartDate}}</li>
                <li><strong>End:</strong> {{' ' + reportEndDate}}</li>
                <li><strong>Crop:</strong>{{' ' + titleCrop }}</li>
                <li><strong>Field: </strong>{{' ' + reportField}}</li>
            </ul>
            <br />
            <p v-if="harvTable.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in harvHeaders">{{ header }}</th>
                </tr>
                <tr v-for="(harvLog, index) in harvTable">
                    <td>{{ timestampToYMD(harvLog.date) }}</td>
                    <td>{{ harvLog.field }}</td>
                    <td>{{ harvLog.crop }}</td>
                    <td>{{ harvLog.yield }}</td>
                    <td>{{ harvLog.worker }}</td>
                    <td>
                        <button type="button" @click="deleteHarvLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
            <p>Total Yield:</p>
            <table border="1">
                <tr v-for="cropYield in yieldTable">
                    <td>{{ cropYield[0] }}</td>
                    <td>{{ cropYield[1] }}</td>
                </tr>
            </table>
        </div>
    </div>
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
    <script>
        var harvRptVue = new Vue({
            el: '#harvRptVue',
            data() {
                return {
<<<<<<< HEAD
                    harvRptTitle: 'My Harvest Report',
                    harvRptCrop: 'ALL',
                    harvRptField: 'ALL',
                    rptStart: this.firstDateOfYear(),
                    rptEnd: this.currentDate(),

                    //These are to make sure that the displayed information is consistent with the displayed table
                    savedTitle: this.harvRptTitle,
                    savedCrop: this.harvRptCrop,
                    savedField: this.harvRptField,
                    savedStart: this.rptStart,
                    savedEnd: this.rptEnd,

                    rptPath: this.getRequestURL,

                    visible: false,

=======
                    rptPath: this.getRequestURL,
                    harvRptTitle: 'My Harvest Report',
                    harvRptCrop: 'ALL',
                    titleCrop: 'ALL',
                    visible: false,
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                    harvHeaders: [
                        'Date',
                        'Field',
                        'Crop',
                        'Yield',
                        'Worker',
                        'Delete',
                    ],
<<<<<<< HEAD
                    totYieldHeaders: ['Crop', 'Total Yield'],

                    //These add the ability to switch back and forth between crops and id numbers
                    cropIdPairsFw: new Map(),  
                    cropIdPairsBw: new Map(),

                    UserIdPairs: new Map(),

                    harvTable: [],
                    yieldTable: [],

                    harvCrops: [],
                    harvFields: ['ALL'],
=======
                    cropIdPairsFw: new Map(),
                    cropIdPairsBw: new Map(),
                    UserIdPairs: new Map(),
                    harvCrops: [],
                    harvTable: [],
                    yieldTable: [],
                    reportField: 'ALL',
                    fields: ['ALL'],
                    reportStartDate: this.firstDateOfYear(),
                    reportEndDate: this.currentDate(),
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                };
            },
            methods: {
                genHarvRpt: function () {
                    this.visible = true;
                    this.makePath();
                    axios.get(this.rptPath).then((response) => {
                        this.harvTable = response.data.list.map((entry) => {
                            return {
<<<<<<< HEAD
                                date: entry.timestamp,
=======
                                date: entry.timestamp, //make human readable
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                                field: entry.area[0].name,
                                crop: this.cropIdPairsFw.get(entry.asset[0].id),
                                yield:
                                    entry.quantity[0].value +
                                    ' ' +
                                    entry.quantity[0].unit.name,
                                worker: this.userIdPairs.get(entry.uid.id),
                            };
                        });
                        this.totalYield();
<<<<<<< HEAD

                        this.savedCrop = this.harvRptCrop;
                        this.savedTitle = this.harvRptTitle;
                        this.savedField = this.harvRptField;
                        this.savedStart = this.rptStart;
                        this.savedEnd = this.rptEnd;
=======
                        this.titleCrop = this.harvRptCrop;
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                    });
                },

                deleteHarvLog: function (nameIndex) {
                    this.yieldTable = [];
                    this.harvTable.splice(nameIndex, 1);
                    this.totalYield();
                },
                totalYield: function () {
                    this.yieldTable = [];
                    yieldTypes = new Map();
                    for (log in this.harvTable) {
                        value = parseFloat(
                            this.harvTable[log].yield.split(' ')[0]
                        );
                        cropUnit =
                            this.harvTable[log].crop +
                            'SPLIT_HERE' +
                            this.harvTable[log].yield.split(' ')[1];

                        if (yieldTypes.has(cropUnit)) {
                            yieldTypes.set(
                                cropUnit,
                                yieldTypes.get(cropUnit) + value
                            );
                        } else {
                            yieldTypes.set(cropUnit, value);
                        }
                    }
                    entries = [...yieldTypes.entries()];
                    for (entry in entries) {
                        addition = [
                            entries[entry][0].split('SPLIT_HERE')[0],
                            entries[entry][1] +
                                ' ' +
                                entries[entry][0].split('SPLIT_HERE')[1],
                        ];
                        this.yieldTable.push(addition);
                    }
                    this.yieldTable.sort();
                },
<<<<<<< HEAD
=======
                // makePath: function () {
                //     this.rptPath =
                //         '/log.json?type=farm_harvest' +
                //         (this.reportField !== 'All'
                //             ? '&area=' + this.reportField
                //             : '') +
                //         '&timestamp[ge]=' +
                //         this.YMDToTimestamp(this.reportStartDate) +
                //         '&timestamp[lt]=' +
                //         this.TimestampFollowingDay(this.reportEndDate);
                //     // +'&timestamp[ge]=' +
                //     // this.YMDToTimestamp(this.rptStart) + '&timestamp[le]=' +this.YMDToTimestamp(this.rptEnd);
                //     console.log(this.rptPath);
                // },
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                makePath: function () {
                    this.rptPath = '/log.json?type=farm_harvest';

                    if (!(this.harvRptCrop == 'ALL')) {
                        this.rptPath +=
                            '&asset=' +
                            this.cropIdPairsBw.get(this.harvRptCrop);
                    }

<<<<<<< HEAD
                    if (!(this.harvRptField == 'ALL')) {
                        this.rptPath += '&area=' + this.harvRptField;
                    }
                    this.rptPath +=
                        '&timestamp[ge]=' +
                        this.YMDToTimestamp(this.rptStart) +
                        '&timestamp[lt]=' +
                        this.TimestampFollowingDay(this.rptEnd);
=======
                    if (!(this.reportField == 'ALL')) {
                            this.rptPath += '&area=' + this.reportField;
                        }
                    this.rptPath +=
                            '&timestamp[ge]=' +
                            this.YMDToTimestamp(this.reportStartDate) +
                            '&timestamp[lt]=' +
                            this.TimestampFollowingDay(this.reportEndDate);
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                },
                YMDToTimestamp: function (ymd) {
                    let d = new Date(ymd);
                    return Math.round(
                        d.getTime() / 1000 + new Date().getTimezoneOffset() * 60
                    );
                },
                TimestampFollowingDay: function (ymd) {
                    return this.YMDToTimestamp(ymd) + 60 * 60 * 24;
                },
                timestampToDate: function (timestamp) {
                    return new Date(timestamp * 1000);
                },
                timestampToYMD: function (timestamp) {
                    let d = this.timestampToDate(timestamp);
                    const month =
                        d.getMonth() < 9
                            ? '0' + (d.getMonth() + 1)
                            : d.getMonth() + 1;
                    const day =
                        d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
                    return d.getFullYear() + '-' + month + '-' + day;
                },
                firstDateOfYear: function () {
                    const date = new Date().getFullYear() + '-01-01';
                    return date;
                },
                currentDate: function () {
                    const d = new Date();
                    const month =
                        d.getMonth() < 9
                            ? '0' + (d.getMonth() + 1)
                            : d.getMonth() + 1;
                    const day =
                        d.getDate() < 10 ? '0' + d.getDate() : d.getDate();
                    return d.getFullYear() + '-' + month + '-' + day;
                },
<<<<<<< HEAD
                makeFile: function () {
                    rawTable = this.harvTable.map(
                        (log) =>
                            this.timestampToYMD(log.date) +
                            ',' +
                            log.field +
                            ',' +
                            log.crop +
                            ',' +
                            log.yield +
                            ',' +
                            log.worker
                    );
                    tableString =
                        this.harvHeaders.slice(0, 5).join(',') +
                        '\n' +
                        rawTable.join('\n');
                    yieldString =
                        this.totYieldHeaders.join(',') +
                        '\n' +
                        this.yieldTable.join('\n');
                    data = new Blob([tableString + '\n\n' + yieldString], {
                        type: 'text/csv',
                    });
                    return window.URL.createObjectURL(data);
                },
=======
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
            },

            created() {
                axios
                    .get('/taxonomy_term.json?area_type=field')
                    .then((response) => {
<<<<<<< HEAD
                        this.harvFields.push(
=======
                        this.fields.push(
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                            ...response.data.list.map((f) => f.name).sort()
                        );
                    })
                    .catch((error) => {
<<<<<<< HEAD
                        this.harvFields = ['Service Unavailable'];
=======
                        this.fields = ['Service Unavailable'];
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                        console.log(error);
                    });
                axios
                    .get('/farm_asset.json?type=planting')
                    .then((response) => {
                        this.cropIdPairsFw = new Map(
                            response.data.list.map((f) => [f.id, f.name])
                        );
                        this.cropIdPairsBw = new Map(
                            response.data.list.map((f) => [f.name, f.id])
                        );
                        this.cropIdPairsFw.set('ALL', 'ALL');
                        this.cropIdPairsBw.set('ALL', 'ALL');
                        this.harvCrops = Array.from(
<<<<<<< HEAD
                            this.cropIdPairsFw.values()
                        ).sort();
                    })
                    .catch((error) => {
                        this.harvFields = ['Service Unavailable'];
=======
                        this.cropIdPairsFw.values()
                        ).sort();
                    })
                    .catch((error) => {
                        this.fields = ['Service Unavailable'];
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                        console.log(error);
                    });
                axios
                    .get('/user')
                    .then((response) => {
                        this.userIdPairs = new Map(
                            response.data.list.map((f) => [f.uid, f.name])
                        );
                    })
                    .catch((error) => {
<<<<<<< HEAD
                        this.harvCrops = ['Service Unavailable'];
=======
                        this.fields = ['Service Unavailable'];
>>>>>>> 1b9a20c2a0393b3c406b55db234f29804a01e1f5
                        console.log(error);
                    });
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
