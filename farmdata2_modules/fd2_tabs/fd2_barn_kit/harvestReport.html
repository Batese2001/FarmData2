<body>
    <h1>Harvest Report</h1>
    <br />
    <p>This page is a form for generating a harvest report</p>
    <br />
    <div id="harvRptVue" v-cloak>
        <label for="rptTitle">Title:</label>
        <input type="text" v-model="harvRptTitle" id="rptTitle" />

        <br /><br />
        <label for="”crop”">Crop:</label>
        <select id="crop" v-model="harvRptCrop">
            <option v-for="crop in harvCrops">{{ crop }}</option>
        </select>
        <br /><br />

        <button class="btn btn-primary" @click="genHarvRpt">
            Generate Report
        </button>
        <div v-if="visible">
            <hr />
            <h1>
                {{ harvRptTitle == '' ? 'My Harvest Report' : harvRptTitle }}
            </h1>
            <br />
            <br />
            <ul>
                <li><strong>Start:</strong>{{}}</li>
                <li><strong>End:</strong> {{}}</li>
                <li><strong>Crop:</strong>{{}}</li>
            </ul>
            <br />
            <p v-if="harvTable.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in harvHeaders">{{ header }}</th>
                </tr>
                <tr v-for="(harvLog, index) in harvTable">
                    <td>{{ harvLog.date }}</td>
                    <td>{{ harvLog.field }}</td>
                    <td>{{ cropIdPairsFw.get(harvLog.crop) }}</td>
                    <td>{{ harvLog.yield }}</td>
                    <td>
                        <button type="button" @click="deleteHarvLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script>
        var harvRptVue = new Vue({
            el: '#harvRptVue',
            data: {
                rptPath: '', //change this and add path creator method when filters are added!
                harvRptTitle: 'My Harvest Report',
                harvRptCrop: 'ALL',
                visible: false,
                harvHeaders: ['Date', 'Field', 'Crop', 'Yield', 'Delete'],
                cropIdPairsFw: new Map(),
                cropIdPairsBw: new Map(),
                harvCrops: [],
                harvLog: [],
                harvTable: [],
            },
            methods: {
                genHarvRpt: function () {
                    this.visible = true;
                    this.makePath();
                    axios.get(this.rptPath).then((response) => {
                        this.harvLog = response.data.list.map((entry) => {
                            //console.log('here');
                            return {
                                date: entry.timestamp, //make human readable
                                field: entry.area[0].name,
                                crop: entry.asset[0].id,
                                yield:
                                    entry.quantity[0].value +
                                    ' ' +
                                    entry.quantity[0].unit.name,
                            };
                        });
                    });
                    while (this.harvTable.length < this.harvLog.length) {
                        this.harvTable.push(
                            this.harvLog[this.harvTable.length]
                        );
                    }
                },
                deleteHarvLog: function (nameIndex) {
                    this.harvTable.splice(nameIndex, 1);
                },
                makePath: function () {
                    this.rptPath ='/log.json?type=farm_harvest'
                    console.log(this.harvRptCrop);
                    this.rptPath += '&asset=' +
                    this.cropIdPairsBw.get(this.harvRptCrop);
                        
                },
            },
            created() {
                axios.get('/farm_asset.json?type=planting').then((response) => {
                    this.cropIdPairsFw = new Map(
                        response.data.list.map((f) => [f.id, f.name])
                    );
                    this.cropIdPairsBw = new Map(
                        response.data.list.map((f) => [f.name, f.id])
                    );

                    this.harvCrops = Array.from(this.cropIdPairsFw.values());
                });
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
