<body>
    <h1>Harvest Report</h1>
    <br />
    <p>This page is a form for generating a harvest report</p>
    <br />
    <div id="harvRptVue" v-cloak>
        <label for="rptTitle">Title:</label>
        <input type="text" v-model="harvRptTitle" id="rptTitle" />

        <br /><br />
        <label for="”crop”">Crop:</label>
        <select id="crop" v-model="harvRptCrop">
            <option v-for="crop in harvCrops">{{ crop }}</option>
        </select>
        <br /><br />

        <button class="btn btn-primary" @click="genHarvRpt">
            Generate Report
        </button>
        <div v-if="visible">
            <hr />
            <h1>
                {{ harvRptTitle == '' ? 'My Harvest Report' : harvRptTitle }}
            </h1>
            <br />
            <br />
            <ul>
                <li><strong>Start:</strong>{{}}</li>
                <li><strong>End:</strong> {{}}</li>
                <li><strong>Crop:</strong>{{' ' + titleCrop }}</li>
            </ul>
            <br />
            <p v-if="harvTable.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in harvHeaders">{{ header }}</th>
                </tr>
                <tr v-for="(harvLog, index) in harvTable">
                    <td>{{ harvLog.date }}</td>
                    <td>{{ harvLog.field }}</td>
                    <td>{{ harvLog.crop }}</td>
                    <td>{{ harvLog.yield }}</td>
                    <td>{{ harvLog.worker }}</td>
                    <td>
                        <button type="button" @click="deleteHarvLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
            <p>Total Yield:</p>
            <table border="1">
                <tr v-for="cropYield in yieldTable">
                    <td>{{ cropYield[0] }}</td>
                    <td>{{ cropYield[1] }}</td>
                </tr>
            </table>
        </div>
    </div>
    <script>
        var harvRptVue = new Vue({
            el: '#harvRptVue',
            data: {
                rptPath: '', 
                harvRptTitle: 'My Harvest Report',
                harvRptCrop: 'ALL',
                titleCrop: 'ALL',
                visible: false,
                harvHeaders: ['Date', 'Field', 'Crop', 'Yield', 'Worker', 'Delete'],
                cropIdPairsFw: new Map(),
                cropIdPairsBw: new Map(),
                UserIdPairs: new Map(),
                harvCrops: [],
                harvTable: [],
                yieldTable: [],
            },
            computed: {},

            methods: {
                genHarvRpt: function () {
                    this.visible = true;
                    this.makePath();
                    axios.get(this.rptPath).then((response) => {
                        this.harvTable = response.data.list.map((entry) => {
                            return {
                                date: entry.timestamp, //make human readable
                                field: entry.area[0].name,
                                crop: this.cropIdPairsFw.get(entry.asset[0].id),
                                yield:
                                    entry.quantity[0].value +
                                    ' ' +
                                    entry.quantity[0].unit.name,
                                worker: this.userIdPairs.get(entry.uid.id),
                            };
                        });
                        this.totalYield();
                        this.titleCrop = this.harvRptCrop;
                    });
                },
                deleteHarvLog: function (nameIndex) {
                    this.yieldTable = [];
                    this.harvTable.splice(nameIndex, 1);
                    this.totalYield();
                },
                totalYield: function () {
                    this.yieldTable = [];
                    yieldTypes = new Map();
                    for (log in this.harvTable) {
                        value = parseFloat(
                            this.harvTable[log].yield.split(' ')[0]
                        );
                        cropUnit =
                            this.harvTable[log].crop +
                            'SPLIT_HERE' +
                            this.harvTable[log].yield.split(' ')[1];

                        if (yieldTypes.has(cropUnit)) {
                            yieldTypes.set(
                                cropUnit,
                                yieldTypes.get(cropUnit) + value
                            );
                        } else {
                            yieldTypes.set(cropUnit, value);
                        }
                    }
                    entries = [...yieldTypes.entries()];
                    for (entry in entries) {
                        addition = [
                            entries[entry][0].split('SPLIT_HERE')[0],
                            entries[entry][1] +
                                ' ' +
                                entries[entry][0].split('SPLIT_HERE')[1],
                        ];
                        this.yieldTable.push(addition);
                    }
                    this.yieldTable.sort()
                },
                makePath: function () {
                    this.rptPath ='/log.json?type=farm_harvest'
                    if (!(this.harvRptCrop == 'ALL')){
                        this.rptPath += '&asset=' +
                        this.cropIdPairsBw.get(this.harvRptCrop);
                    }
                        
                },
            },
            created() {
                axios.get('/farm_asset.json?type=planting').then((response) => {
                    this.cropIdPairsFw = new Map(
                        response.data.list.map((f) => [f.id, f.name])
                    );
                    this.cropIdPairsBw = new Map(
                        response.data.list.map((f) => [f.name, f.id])
                    );
                    this.cropIdPairsFw.set('ALL', 'ALL');
                    this.cropIdPairsBw.set('ALL', 'ALL');
                    this.harvCrops = Array.from(this.cropIdPairsFw.values());
                }),
                axios.get('/user').then((response) => {
                    this.userIdPairs = new Map(
                        response.data.list.map((f) => [f.uid, f.name])
                    );
                });
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
