<body>
    <h1>Harvest Report</h1>
    <br />
    <p>This page is a form for generating a harvest report</p>
    <br />
    <div id="harvRptVue" v-cloak>
        <label for="rptTitle">Title:</label>
        <input type="text" v-model="harvRptTitle" id="rptTitle" />

        <br /><br />

        <button class="btn btn-primary" @click="genHarvRpt">
            Generate Report
        </button>
        <div v-if="visible">
            <hr />
            <h1>
                {{ harvRptTitle == '' ? 'My Harvest Report' : harvRptTitle }}
            </h1>
            <br />
            <br />
            <ul>
                <li><strong>Start:</strong>{{}}</li>
                <li><strong>End:</strong> {{}}</li>
                <li><strong>Crop:</strong>{{}}</li>
            </ul>
            <br />
            <p v-if="harvTable.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in harvHeaders">{{ header }}</th>
                </tr>
                <tr v-for="(harvLog, index) in harvTable">
                    <td>{{ harvLog.date }}</td>
                    <td>{{ harvLog.field }}</td>
                    <td>{{ harvLog.crop }}</td>
                    <td>{{ harvLog.yield }}</td>
                    <td>
                        <button type="button" @click="deleteHarvLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
            <p>Total Yield:</p>
            <table border="1">
                <tr v-for="cropYield in yieldTable">
                    <td>{{ cropYield[0] }}</td>
                    <td>{{ cropYield[1] }}</td>
                </tr>
            </table>
        </div>
    </div>
    <script>
        var harvRptVue = new Vue({
            el: '#harvRptVue',
            data: {
                rptPath: '/log.json?type=farm_harvest', //change this and add path creator method when filters are added!
                harvRptTitle: 'My Harvest Report',
                visible: false,
                harvHeaders: ['Date', 'Field', 'Crop', 'Yield', 'Delete'],
                harvLog: [],
                harvTable: [],
                yieldTable: [],
            },
            computed: {},

            methods: {
                genHarvRpt: function () {
                    this.visible = true;
                    axios.get(this.rptPath).then((response) => {
                        this.harvLog = response.data.list.map((entry) => {
                            //console.log('here');
                            return {
                                date: entry.timestamp, //make human readable
                                field: entry.area[0].name,
                                crop: entry.name.split(' ')[
                                    entry.name.split(' ').length - 1
                                ],
                                yield:
                                    entry.quantity[0].value +
                                    ' ' +
                                    entry.quantity[0].unit.name,
                            };
                        });
                        this.totalYield()
                    });
                    while (this.harvTable.length < this.harvLog.length) {
                        this.harvTable.push(
                            this.harvLog[this.harvTable.length]
                        );
                    }
                    //this.yieldTable = totalYield();
                },
                deleteHarvLog: function (nameIndex) {
                    this.harvTable.splice(nameIndex, 1);
                    //this.yieldTable = totalYield();
                },
                totalYield: function () {
                    yieldTypes = new Map();
                    for (log in this.harvTable) {
                        value = parseFloat(
                            this.harvTable[log].yield.split(' ')[0]
                        );
                        cropUnit =
                            this.harvTable[log].crop +
                            ' ' +
                            this.harvTable[log].yield.split(' ')[1];

                        if (yieldTypes.has(cropUnit)) {
                            yieldTypes.set(
                                cropUnit,
                                yieldTypes.get(cropUnit) + value
                            );
                        } else {
                            yieldTypes.set(cropUnit, value);
                        }
                    }
                    entries = [...yieldTypes.entries()];
                    for (entry in entries) {
                        addition = [
                            entries[entry][0].split(' ')[0],
                            entries[entry][1] +
                                ' ' +
                                entries[entry][0].split(' ')[1],
                        ];
                        this.yieldTable.push(addition);
                    }
                },
            },
        });
        Vue.config.devtools = true;
    </script>
</body>
