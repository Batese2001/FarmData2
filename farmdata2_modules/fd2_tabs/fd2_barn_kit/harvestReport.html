<body>
    <h1>Harvest Report</h1>
    <br />
    <p>This page is a form for generating a harvest report</p>
    <br />
    <div id="harvRptVue" v-cloak>
        <label for="rptTitle">Title:</label>
        <input type="text" v-model="harvRptTitle" id="rptTitle" />

        <label for="field">Field: </label>
        <select v-model="reportField">
            <option v-for="field in fields">{{field}}</option>
        </select>

        <div>
            <label for="start">Start:</label>
            <input type="date" id="start" v-model="reportStartDate">
    
            <label for="end">End:</label>
            <input type="date" id="end" v-model="reportEndDate">
        </div>

        <br /><br />

        <button class="btn btn-primary" @click="genHarvRpt">
            Generate Report
        </button>
        <div v-if="visible">
            <hr />
            <h1>
                {{ harvRptTitle == '' ? 'My Harvest Report' : harvRptTitle }}
            </h1>
            <br />
            <br />
            <ul>
                <li><strong>Start:</strong>{{}}</li>
                <li><strong>End:</strong> {{}}</li>
                <li><strong>Crop:</strong>{{}}</li>
                <li><strong>Field: </strong>{{reportField}}</li>
            </ul>
            <br />
            <p v-if="harvLog.length == 0">There are no matching records.</p>
            <table border="1" v-else>
                <tr>
                    <th v-for="header in harvHeaders">{{ header }}</th>
                </tr>
                <tr v-for="(harvLog, index) in harvLog">
                    <td>{{ harvLog.date }}</td>
                    <td>{{ harvLog.field }}</td>
                    <td>{{ harvLog.crop }}</td>
                    <td>{{ harvLog.yield }}</td>
                    <td>
                        <button type="button" @click="deleteHarvLog(index)">
                            Delete
                        </button>
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <script>
        var harvRptVue = new Vue({
            el: '#harvRptVue',
            data () {
                return {
                    rptPath: this.getRequestURL, //change this and add path creator method when filters are added!
                    harvRptTitle: 'My Harvest Report',
                    visible: false,
                    harvHeaders: ['Date', 'Field', 'Crop', 'Yield', 'Delete'],
                    harvLog: [],
                    // harvTable: [],
                    reportField: "",
                    fields: ["All"],
                    reportStartDate: this.firstDateOfYear(),
                    reportEndDate: this.currentDate(),
                }
            },
            methods: {
                genHarvRpt: function () {
                    this.makePath();
                    axios.get(this.rptPath).then((response) => {
                        this.harvLog = response.data.list.map((entry) => {
                            //console.log('here');
                            return {
                                date: entry.timestamp, //make human readable
                                field: entry.area[0].name,
                                crop: entry.name.split(' ')[
                                    entry.name.split(' ').length - 1
                                ],
                                yield:
                                    entry.quantity[0].value +
                                    ' ' +
                                    entry.quantity[0].unit.name,
                            };
                        });
                    });
                    // while (this.harvTable.length < this.harvLog.length) {
                    //     this.harvTable.push(
                    //         this.harvLog[this.harvTable.length]
                    //     );
                    // }
                    this.visible = true;
                },
                makePath: function () {
                    this.rptPath =
                        '/log.json?type=farm_harvest' + (this.reportField !== "All" ? '&area=' + this.reportField : '')
                        + '&timestamp[ge]=' + this.YMDToTimestamp(this.reportStartDate) + '&timestamp[lt]=' + this.TimestampFollowingDay(this.reportEndDate);
                        // +'&timestamp[ge]=' +
                        // this.YMDToTimestamp(this.rptStart) + '&timestamp[le]=' +this.YMDToTimestamp(this.rptEnd);
                    console.log(this.rptPath)
                },
                deleteHarvLog: function (nameIndex) {
                    this.harvTable.splice(nameIndex, 1);
                },
                YMDToTimestamp: function(ymd) {
                let d = new Date(ymd);
                return Math.round(d.getTime()/1000 +
                        new Date().getTimezoneOffset()*60);
                },
                TimestampFollowingDay: function(ymd) {
                return this.YMDToTimestamp(ymd) + 60*60*24
                },
                timestampToDate: function(timestamp) {
                return new Date(timestamp * 1000);
                },
                timestampToYMD: function(timestamp) {
                let d = this.timestampToDate(timestamp);
                const month = d.getMonth() < 9 ?
                                '0' + (d.getMonth() + 1) :
                                d.getMonth() + 1;
                const day = d.getDate() < 10 ?
                            '0' + d.getDate() :
                                d.getDate();
                return d.getFullYear() + "-" + month + "-" + day;
                },
                firstDateOfYear: function(){
                    const date = new Date().getFullYear() + "-01-01"
                    return date
                },
                currentDate: function(){
                    const d = new Date()
                    const month = d.getMonth() < 9 ?
                                '0' + (d.getMonth() + 1) :
                                d.getMonth() + 1;
                const day = d.getDate() < 10 ?
                            '0' + d.getDate() :
                                d.getDate();
                return d.getFullYear() + "-" + month + "-" + day;
                }
        },
            
            created() {
            axios.get('/taxonomy_term.json?area_type=field')
            .then(response => {
                this.fields.push(...response.data.list.map(f => f.name).sort());
            }
            ).catch(error => {
                this.fields = ['Service Unavailable'];
                console.log(error)
            });
            }
        });
        Vue.config.devtools = true;
    </script>
</body>
